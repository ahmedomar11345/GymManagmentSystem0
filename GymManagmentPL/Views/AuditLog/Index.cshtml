@inject IStringLocalizer<SharedResource> Localizer
@model IEnumerable<GymManagmentDAL.Entities.AuditLog>

@{
    ViewData["Title"] = Localizer["AuditLogs"];
}

<div class="row mb-4 align-items-center mt-4">
    <div class="col-md-6">
        <h2 class="fw-bold mb-0">@Localizer["SystemAuditLogs"]</h2>
        <p class="text-secondary">@Localizer["AuditLogsDesc"]</p>
    </div>
    <div class="col-md-6 text-md-end">
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary shadow-sm rounded-pill px-4">
            <i class="fas fa-arrow-left me-2"></i> @Localizer["Dashboard"]
        </a>
    </div>
</div>

<div class="table-responsive rounded-4 border overflow-hidden">
    <table class="table table-hover align-middle mb-0">
        <thead class="bg-light">
            <tr>
                <th class="ps-4">@Localizer["Timestamp"]</th>
                <th>@Localizer["User"]</th>
                <th>@Localizer["Action"]</th>
                <th>@Localizer["Entity"]</th>
                <th>@Localizer["EntityID"]</th>
                <th class="text-center">@Localizer["Details"]</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var log in Model)
            {
                <tr>
                    <td class="ps-4">
                        <div class="small fw-bold">@log.Timestamp.ToString("yyyy-MM-dd")</div>
                        <div class="text-muted small">@log.Timestamp.ToString("HH:mm:ss")</div>
                    </td>
                    <td>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill">
                            <i class="fas fa-user me-1"></i> @log.UserName
                        </span>
                    </td>
                    <td>
                        @{
                            var badgeClass = log.Action switch
                            {
                                "Create" => "bg-success",
                                "Update" => "bg-warning text-dark",
                                "Delete" => "bg-danger",
                                _ => "bg-info"
                            };
                        }
                        <span class="badge @badgeClass rounded-pill px-3">@Localizer[log.Action]</span>
                    </td>
                    <td><span class="fw-medium">@Localizer[log.EntityName]</span></td>
                    <td><code>#@log.EntityId</code></td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-primary rounded-circle" style="width: 32px; height: 32px; padding: 0;"
                                onclick="showLogDetails('@log.Id', '@log.Action', '@log.EntityName', @Html.Raw(Json.Serialize(log.OldValues)), @Html.Raw(Json.Serialize(log.NewValues)))">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Details Modal -->
<div class="modal fade" id="logModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="logModalTitle">@Localizer["AuditLogDetails"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-md-6">
                        <h6 class="fw-bold text-danger mb-3"><i class="fas fa-history me-2"></i>@Localizer["OldValues"]</h6>
                        <pre id="oldValues" class="bg-light p-3 rounded-4 border" style="font-size: 0.8rem; max-height: 400px; overflow: auto;"></pre>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold text-success mb-3"><i class="fas fa-plus-circle me-2"></i>@Localizer["NewValues"]</h6>
                        <pre id="newValues" class="bg-light p-3 rounded-4 border" style="font-size: 0.8rem; max-height: 400px; overflow: auto;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showLogDetails(id, action, entity, oldVal, newVal) {
            const localizer = {
                on: "@Localizer["on"]"
            };
            document.getElementById('logModalTitle').innerText = `${action} ${localizer.on} ${entity} (#${id})`;
            
            const oldPre = document.getElementById('oldValues');
            const newPre = document.getElementById('newValues');
            
            const noDataText = "@Localizer["NoData"]";
            
            try {
                oldPre.innerText = oldVal ? JSON.stringify(JSON.parse(oldVal), null, 2) : noDataText;
                newPre.innerText = newVal ? JSON.stringify(JSON.parse(newVal), null, 2) : noDataText;
            } catch (e) {
                oldPre.innerText = oldVal || noDataText;
                newPre.innerText = newVal || noDataText;
            }
            
            new bootstrap.Modal(document.getElementById('logModal')).show();
        }
    </script>
}
