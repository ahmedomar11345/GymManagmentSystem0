@model IEnumerable<GymManagmentDAL.Entities.TrainerSpecialty>
@inject IStringLocalizer<SharedResource> Localizer
@{
    ViewData["Title"] = Localizer["ManageSpecialties"];
    var totalTrainers = Model.Sum(s => s.Trainers?.Count ?? 0);
}

<style>
    .glass-header {
        background: var(--card-bg, rgba(255,255,255,0.7));
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border, rgba(255,255,255,0.4));
        border-radius: 16px;
    }
    [data-theme="dark"] .glass-header {
        background: rgba(30,41,59,0.8);
        border-color: rgba(255,255,255,0.08);
    }

    /* Modal inputs in dark mode */
    [data-theme="dark"] .modal-content {
        background: #1e293b !important;
        color: #f1f5f9 !important;
    }
    [data-theme="dark"] .modal-content .form-control,
    [data-theme="dark"] .modal-content textarea {
        background: #0f172a !important;
        border-color: #334155 !important;
        color: #f1f5f9 !important;
    }
    [data-theme="dark"] .modal-content .form-control::placeholder,
    [data-theme="dark"] .modal-content textarea::placeholder {
        color: #64748b !important;
        opacity: 1 !important;
    }
    [data-theme="dark"] .modal-content .input-group-text {
        background: #0f172a !important;
        border-color: #334155 !important;
        color: #94a3b8 !important;
    }
    [data-theme="dark"] .modal-content label {
        color: #94a3b8 !important;
    }

    /* Stats cards */
    .spec-stat-card {
        background: var(--card-bg, #fff);
        border: 1px solid var(--glass-border, rgba(226,232,240,.8));
        border-radius: 14px;
        padding: 1.1rem 1.25rem;
        box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    [data-theme="dark"] .spec-stat-card {
        background: #1e293b !important;
        border-color: #334155 !important;
    }
    [data-theme="dark"] .spec-stat-card h3 { color: #f8fafc !important; }

    /* Search box */
    .search-box { position: relative; width: 280px; }
    .search-icon {
        position: absolute;
        top: 50%; transform: translateY(-50%);
        color: #adb5bd; z-index: 5;
    }
    [dir="ltr"] .search-icon { left: 14px; }
    [dir="rtl"] .search-icon { right: 14px; left: auto; }
    [dir="ltr"] .search-box input { padding-left: 2.5rem; }
    [dir="rtl"] .search-box input { padding-right: 2.5rem; padding-left: .75rem; }

    [data-theme="dark"] .search-box input {
        background: rgba(15,23,42,.6);
        border-color: rgba(255,255,255,.1);
        color: #f8fafc;
    }
    [data-theme="dark"] .search-box input::placeholder { color: rgba(255,255,255,.35); }

    /* Table */
    .custom-table thead th {
        background: #f8fafc;
        color: #64748b;
        font-size: .75rem;
        letter-spacing: .05em;
    }
    [data-theme="dark"] .custom-table thead th {
        background: #0f172a !important;
        color: #94a3b8 !important;
        border-color: #334155 !important;
    }
    [data-theme="dark"] .custom-table tbody td {
        color: #cbd5e1 !important;
        border-color: #334155 !important;
    }
    [data-theme="dark"] .custom-table tbody tr { background: #1e293b !important; }
    [data-theme="dark"] .custom-table tbody tr:hover td { background: rgba(255,255,255,.04) !important; }

    .specialty-row { transition: background .15s ease; }
    [dir="ltr"] .specialty-row:hover { border-right: 3px solid #3b82f6; }
    [dir="rtl"] .specialty-row:hover { border-left: 3px solid #3b82f6; }

    .specialty-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    /* Action buttons */
    .btn-icon {
        width: 34px; height: 34px; padding: 0;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 50%; background: var(--card-bg, #fff);
        transition: transform .2s, box-shadow .2s;
    }
    .btn-icon:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,.12); }
    [data-theme="dark"] .btn-icon { background: #334155 !important; border-color: #475569 !important; }

    /* Modal header */
    [data-theme="dark"] .modal-header { background: #0f172a !important; border-color: #334155 !important; }
    [data-theme="dark"] .modal-header h5 { color: #f8fafc !important; }

    /* Fix modal z-index */
    .modal { z-index: 2500 !important; }
    .modal-backdrop { z-index: 2400 !important; }
</style>

<div class="py-4">
    <!-- ── Header ── -->
    <div class="glass-header p-4 mb-4 d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div class="d-flex align-items-center gap-3">
            <div class="icon-shape bg-primary text-white rounded-3 shadow-sm">
                <i class="fas fa-tags fa-lg"></i>
            </div>
            <div>
                <h4 class="fw-bold mb-0">@Localizer["TrainerSpecialties"]</h4>
                <p class="text-muted small mb-0">@Localizer["ManageSpecialtiesDesc"]</p>
            </div>
        </div>
        <div class="d-flex gap-2 flex-wrap align-items-center">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="specialtySearch" class="form-control rounded-pill"
                       placeholder="@Localizer["SearchSpecialties"]">
            </div>
            <button class="btn btn-primary rounded-pill px-4 shadow-sm"
                    data-bs-toggle="modal" data-bs-target="#createModal">
                <i class="fas fa-plus me-2"></i>@Localizer["AddNewSpecialty"]
            </button>
        </div>
    </div>

    <!-- ── Stats ── -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="spec-stat-card d-flex align-items-center gap-3">
                <div class="rounded-3 bg-primary bg-opacity-10 p-3">
                    <i class="fas fa-list-ul text-primary"></i>
                </div>
                <div>
                    <h3 class="fw-bold mb-0">@Model.Count()</h3>
                    <p class="text-muted small mb-0">@Localizer["TotalCategories"]</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="spec-stat-card d-flex align-items-center gap-3">
                <div class="rounded-3 bg-success bg-opacity-10 p-3">
                    <i class="fas fa-user-tie text-success"></i>
                </div>
                <div>
                    <h3 class="fw-bold mb-0">@totalTrainers</h3>
                    <p class="text-muted small mb-0">@Localizer["TotalActiveTrainers"]</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ── Table ── -->
    <div class="premium-card overflow-hidden p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 custom-table" id="specialtiesTable">
                <thead>
                    <tr>
                        <th class="ps-4 py-3 text-uppercase small fw-bold">@Localizer["Name"]</th>
                        <th class="py-3 text-uppercase small fw-bold">@Localizer["Description"]</th>
                        <th class="py-3 text-uppercase small fw-bold text-center">@Localizer["TrainersCount"]</th>
                        <th class="py-3 text-uppercase small fw-bold">@Localizer["CreatedAt"]</th>
                        <th class="pe-4 py-3 text-uppercase small fw-bold text-end">@Localizer["Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <i class="fas fa-folder-open fa-3x text-secondary opacity-25 d-block mb-3"></i>
                                <h6 class="text-muted">@Localizer["NoSpecialtiesFound"]</h6>
                            </td>
                        </tr>
                    }
                    @foreach (var item in Model)
                    {
                        <tr class="specialty-row">
                            <td class="ps-4">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="specialty-dot bg-primary"></span>
                                    <span class="fw-bold">@item.Name</span>
                                </div>
                            </td>
                            <td class="text-muted small">
                                @(string.IsNullOrEmpty(item.Description) ? "—" : item.Description)
                            </td>
                            <td class="text-center">
                                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3 py-2 fw-semibold">
                                    <i class="fas fa-users-cog me-1"></i>@(item.Trainers?.Count ?? 0)
                                </span>
                            </td>
                            <td class="small text-muted">
                                <i class="far fa-calendar-alt me-1 opacity-50"></i>
                                @item.CreatedAt.ToString("g")
                            </td>
                            <td class="pe-4 text-end">
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-sm btn-icon border btn-edit"
                                            data-id="@item.Id"
                                            data-name="@item.Name"
                                            data-desc="@item.Description"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editModal"
                                            title="@Localizer["Edit"]">
                                        <i class="fas fa-edit text-info"></i>
                                    </button>
                                    <form asp-action="Delete" asp-route-id="@item.Id" method="post"
                                          class="d-inline delete-form"
                                          data-name="@item.Name">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-icon border"
                                                title="@Localizer["Delete"]">
                                            <i class="fas fa-trash-alt text-danger"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ── Create Modal ── -->
<div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 py-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h5 class="fw-bold mb-0">@Localizer["AddNewSpecialty"]</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="Create" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body py-3 px-4">
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-uppercase text-muted">@Localizer["SpecialtyName"]</label>
                        <div class="input-group">
                            <span class="input-group-text border-end-0 rounded-start-3"><i class="fas fa-tag text-muted"></i></span>
                            <input type="text" name="name" class="form-control border-start-0 rounded-end-3 py-2"
                                   placeholder="@Localizer["SpecialtyNamePlaceholder"]" required />
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small fw-bold text-uppercase text-muted">@Localizer["Description"]</label>
                        <textarea name="Description" class="form-control rounded-3 py-2" rows="3"
                                  placeholder="@Localizer["SpecialtyDescPlaceholder"]"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 px-4 pb-4">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">
                        <i class="fas fa-save me-1"></i>@Localizer["Save"]
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ── Edit Modal ── -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 py-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-info bg-opacity-10 text-info p-2 rounded-3">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h5 class="fw-bold mb-0">@Localizer["EditSpecialty"]</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="Edit" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="editId" />
                <div class="modal-body py-3 px-4">
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-uppercase text-muted">@Localizer["SpecialtyName"]</label>
                        <div class="input-group">
                            <span class="input-group-text border-end-0 rounded-start-3"><i class="fas fa-tag text-muted"></i></span>
                            <input type="text" name="name" id="editName" class="form-control border-start-0 rounded-end-3 py-2"
                                   placeholder="@Localizer["SpecialtyNamePlaceholder"]" required />
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small fw-bold text-uppercase text-muted">@Localizer["Description"]</label>
                        <textarea name="Description" id="editDesc" class="form-control rounded-3 py-2" rows="3"
                                  placeholder="@Localizer["SpecialtyDescPlaceholder"]"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 px-4 pb-4">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">
                        <i class="fas fa-check-circle me-1"></i>@Localizer["Update"]
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Localized strings (safe encoding via Json.Serialize)
            const lblDelete  = @Json.Serialize(Localizer["Delete"].Value);
            const lblConfirm = @Json.Serialize(Localizer["DeleteSpecialtyConfirm"].Value);
            const lblCancel  = @Json.Serialize(Localizer["Cancel"].Value);

            // Move modals to body to fix stacking context issues
            ['createModal', 'editModal'].forEach(id => {
                const el = document.getElementById(id);
                if (el) document.body.appendChild(el);
            });

            // Edit modal data mapping
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.getElementById('editId').value = this.dataset.id;
                    document.getElementById('editName').value = this.dataset.name;
                    document.getElementById('editDesc').value = this.dataset.desc || '';
                });
            });

            // Delete with SweetAlert2
            document.querySelectorAll('.delete-form').forEach(form => {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    if (!window.Swal) { this.submit(); return; }
                    Swal.fire({
                        title: lblDelete,
                        text: lblConfirm,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: lblDelete,
                        cancelButtonText: lblCancel,
                        buttonsStyling: false,
                        customClass: {
                            popup: 'premium-swal-popup',
                            title: 'premium-swal-title',
                            confirmButton: 'premium-swal-confirm btn btn-danger px-4',
                            cancelButton: 'premium-swal-cancel btn btn-outline-secondary px-4'
                        }
                    }).then(result => { if (result.isConfirmed) form.submit(); });
                });
            });

            // Quick search filter
            document.getElementById('specialtySearch').addEventListener('keyup', function () {
                const val = this.value.toLowerCase();
                document.querySelectorAll('#specialtiesTable tbody tr').forEach(row => {
                    row.style.display = row.textContent.toLowerCase().includes(val) ? '' : 'none';
                });
            });
        });
    </script>
}
