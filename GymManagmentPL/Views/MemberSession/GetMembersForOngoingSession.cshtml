@inject IStringLocalizer<SharedResource> Localizer
@model GymManagmentBLL.ViewModels.MemberSessionViewModel.SessionMembersViewModel

@{
    ViewData["Title"] = Localizer["AttendanceSheet"];
}

<div class="row mb-4 align-items-center mt-4">
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a asp-action="Index">@Localizer["Bookings"]</a></li>
                <li class="breadcrumb-item active">@Localizer["Attendance"]</li>
            </ol>
        </nav>
        <h2 class="fw-bold mb-0 text-success">
            <i class="fas fa-check-double me-2"></i> @Localizer["Attendance"]: @Model.SessionName
        </h2>
    </div>
</div>

@if (Model.Bookings != null && Model.Bookings.Any())
{
    var attended = Model.Bookings.Count(b => b.IsAttended);
    var total = Model.Bookings.Count();
    var percent = (double)attended / total * 100;

    <div class="premium-card p-4 mb-4 shadow-sm border-0">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold mb-0">@Localizer["AttendanceProgress"]</h6>
            <span class="badge bg-success">@attended / @total @Localizer["Present"]</span>
        </div>
        <div class="progress rounded-pill" style="height: 10px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: @percent%"></div>
        </div>
    </div>

    <div class="premium-card p-0 shadow-sm border-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">@Localizer["MemberName"]</th>
                        <th class="text-center">@Localizer["Status"]</th>
                        <th class="text-end pe-4">@Localizer["Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var booking in Model.Bookings)
                    {
                        <tr class="@(booking.IsAttended ? "table-success bg-opacity-10" : "")">
                            <td class="ps-4">
                                <span class="fw-bold">@booking.MemberName</span>
                            </td>
                            <td class="text-center">
                                @if (booking.IsAttended)
                                {
                                    <span class="badge bg-success rounded-pill px-3 py-2"><i class="fas fa-check me-1"></i> @Localizer["Attended"]</span>
                                }
                                else if (booking.Status == "Waitlisted")
                                {
                                    <span class="badge bg-warning text-dark rounded-pill px-3 py-2">@Localizer["Waitlisted"]</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary rounded-pill px-3 py-2">@Localizer["Pending"]</span>
                                }
                            </td>
                            <td class="text-end pe-4">
                                @if (!booking.IsAttended && booking.Status == "Confirmed")
                                {
                                    <div class="btn-group">
                                        <form asp-action="MarkAttendance" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="memberId" value="@booking.MemberId" />
                                            <input type="hidden" name="sessionId" value="@Model.SessionId" />
                                            <button type="submit" class="btn btn-sm btn-success rounded-pill px-3 me-2">
                                                @Localizer["MarkPresent"]
                                            </button>
                                        </form>
                                        <button type="button" class="btn btn-sm btn-outline-danger border-0 remove-member-btn rounded-pill px-2" 
                                                data-member-id="@booking.MemberId"
                                                data-member-name="@booking.MemberName">
                                            <i class="fas fa-user-minus"></i>
                                        </button>
                                    </div>
                                }
                                else if (booking.Status == "Waitlisted")
                                {
                                     <button type="button" class="btn btn-sm btn-outline-danger border-0 remove-member-btn rounded-pill px-2" 
                                                data-member-id="@booking.MemberId"
                                                data-member-name="@booking.MemberName">
                                            <i class="fas fa-user-minus me-1"></i> @Localizer["RemoveFromWaitlist"]
                                        </button>
                                }
                                else
                                {
                                    <span class="text-success small fw-bold"><i class="fas fa-check-circle me-1"></i> @Localizer["Logged"]</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else
{
    <div class="premium-card p-5 text-center shadow-sm border-0">
        <i class="fas fa-user-slash fs-1 text-secondary opacity-25 mb-3"></i>
        <h5 class="fw-bold">@Localizer["NoMembersMatched"]</h5>
        <p class="text-muted">@Localizer["NoMembersMatchedDesc"]</p>
        <a asp-action="Index" class="btn btn-dark rounded-pill mt-2">@Localizer["BackToBookings"]</a>
    </div>
}

<div class="mt-4">
    <a asp-action="Index" class="btn btn-light border rounded-pill px-4"><i class="fas fa-arrow-left me-2"></i> @Localizer["BackToLiveList"]</a>
</div>

<form id="removeForm" asp-action="Cancel" method="post" style="display:none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="memberId" id="removeMemberId" />
    <input type="hidden" name="sessionId" value="@Model.SessionId" />
</form>

@section Scripts {
    <script src="~/js/session.js" asp-append-version="true"></script>
}
