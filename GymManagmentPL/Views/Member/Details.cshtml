@inject IStringLocalizer<SharedResource> Localizer
@model MemberViewModel
@{
    ViewData["Title"] = Localizer["MemberDetails"];
}

<div class="row mb-4 align-items-center mt-4">
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a asp-action="Index" class="text-decoration-none">@Localizer["Members"]</a></li>
                <li class="breadcrumb-item active">@Model.Name</li>
            </ol>
        </nav>
        <h2 class="fw-bold mb-0">
            <i class="fas fa-user text-primary me-2"></i>@Localizer["MemberProfile"]
        </h2>
    </div>
    <div class="col-md-6 text-md-end">
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary me-2 rounded-pill px-4">
            <i class="fas fa-edit me-2"></i>@Localizer["EditProfile"]
        </a>
        <a asp-action="Index" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fas fa-arrow-left me-2"></i>@Localizer["BackToList"]
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- Profile Card -->
    <div class="col-lg-4">
        <div class="premium-card p-4 text-center h-100 shadow-sm border-0">
            <!-- Profile Photo -->
            <div class="position-relative d-inline-block mb-4">
                <img src="~/images/members/@Model.Photo" alt="@Model.Name" 
                     class="rounded-circle shadow-lg"
                     style="width: 150px; height: 150px; object-fit: cover; border: 4px solid #fff;" 
                     onerror="this.src='/images/members/default-avatar.png'" />
                <span class="position-absolute bottom-0 end-0 bg-success border border-3 border-white rounded-circle" 
                      style="width: 24px; height: 24px;" title="@Localizer["ActiveMember"]"></span>
            </div>
            
            <!-- Name & Plan -->
            <h3 class="fw-bold mb-1">@Model.Name</h3>
            @if (!string.IsNullOrEmpty(Model.PlaneName))
            {
                <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 mb-3 rounded-pill">
                    <i class="fas fa-crown me-1"></i>@Model.PlaneName
                </span>
            }
            else
            {
                <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 mb-3 rounded-pill">
                    <i class="fas fa-times-circle me-1"></i>@Localizer["NoActivePlan"]
                </span>
            }
            
            <!-- Quick Stats -->
            <div class="row g-2 mt-3">
                <div class="col-6">
                    <div class="p-3 bg-primary bg-opacity-10 rounded-4">
                        <i class="fas fa-calendar-check text-primary fs-4 mb-2"></i>
                        <div class="small text-secondary">@Localizer["MemberSince"]</div>
                        <div class="fw-bold">@Model.JoinDate.ToString("MMM yyyy")</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 bg-success bg-opacity-10 rounded-4">
                        <i class="fas fa-dumbbell text-success fs-4 mb-2"></i>
                        <div class="small text-secondary">@Localizer["Sessions"]</div>
                        <div class="fw-bold">@(Model.SessionsBooked ?? 0)</div>
                    </div>
                </div>
            </div>

            <!-- Digital Member ID -->
            <div class="mt-4 p-4 border-0 rounded-4 bg-light shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="small fw-bold text-uppercase text-secondary">@Localizer["DigitalMemberID"]</span>
                    <i class="fas fa-qrcode text-dark opacity-50"></i>
                </div>
                <div class="text-center">
                    <div class="bg-white p-2 d-inline-block rounded-3 shadow-sm border mb-3">
                        <canvas id="qr-code" style="max-width: 100%; height: auto;"></canvas>
                    </div>
                    <div class="fw-mono small text-secondary">ID: GYM-@Model.Id.ToString("D5")</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Section -->
    <div class="col-lg-8">
        <!-- Personal Information -->
        <div class="premium-card p-4 mb-4 shadow-sm border-0">
            <div class="d-flex align-items-center mb-4">
                <div class="icon-shape bg-primary bg-opacity-10 text-primary me-3">
                    <i class="fas fa-id-card"></i>
                </div>
                <h5 class="fw-bold mb-0">@Localizer["PersonalInformation"]</h5>
            </div>
            
            <div class="row g-4 px-2">
                <div class="col-md-6">
                    <div class="d-flex align-items-start">
                        <div class="text-primary me-3"><i class="fas fa-envelope fs-5"></i></div>
                        <div>
                            <div class="small text-secondary text-uppercase fw-bold mb-1">@Localizer["EmailAddress"]</div>
                            <div class="fw-medium">@Model.Email</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-start">
                        <div class="text-primary me-3"><i class="fas fa-phone fs-5"></i></div>
                        <div>
                            <div class="small text-secondary text-uppercase fw-bold mb-1">@Localizer["Phone"]</div>
                            <div class="fw-medium">@Model.Phone</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-start">
                        <div class="text-primary me-3"><i class="fas fa-venus-mars fs-5"></i></div>
                        <div>
                            <div class="small text-secondary text-uppercase fw-bold mb-1">@Localizer["Gender"]</div>
                            <div class="fw-medium">@Localizer[Model.Gender]</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-start">
                        <div class="text-primary me-3"><i class="fas fa-birthday-cake fs-5"></i></div>
                        <div>
                            <div class="small text-secondary text-uppercase fw-bold mb-1">@Localizer["DateOfBirth"]</div>
                            <div class="fw-medium">@Model.DateOfBirth</div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="d-flex align-items-start border-top pt-4">
                        <div class="text-primary me-3"><i class="fas fa-map-marker-alt fs-5"></i></div>
                        <div>
                            <div class="small text-secondary text-uppercase fw-bold mb-1">@Localizer["Address"]</div>
                            <div class="fw-medium">@(Model.Address ?? Localizer["NoAddressProvided"].Value)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Membership Information -->
        <div class="premium-card p-4 mb-4 shadow-sm border-0">
            <div class="d-flex align-items-center mb-4">
                <div class="icon-shape bg-success bg-opacity-10 text-success me-3">
                    <i class="fas fa-id-badge"></i>
                </div>
                <h5 class="fw-bold mb-0">@Localizer["MembershipDetails"]</h5>
            </div>
            
            <div class="row g-4 px-2 text-center">
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded-4">
                        <div class="small text-secondary text-uppercase fw-bold mb-2">@Localizer["CurrentPlan"]</div>
                        <div class="fs-5 fw-bold text-primary">@(Model.PlaneName ?? Localizer["None"].Value)</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded-4">
                        <div class="small text-secondary text-uppercase fw-bold mb-2">@Localizer["StartDate"]</div>
                        <div class="fs-5 fw-bold">@(Model.MembershipStartDate ?? Localizer["NA"].Value)</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded-4">
                        <div class="small text-secondary text-uppercase fw-bold mb-2">@Localizer["EndDate"]</div>
                        <div class="fs-5 fw-bold">@(Model.MembershipEndDate ?? Localizer["NA"].Value)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Record -->
        <div class="premium-card p-4 mb-4 shadow-sm border-0">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-danger bg-opacity-10 text-danger me-3">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <h5 class="fw-bold mb-0">@Localizer["HealthRecord"]</h5>
                    </div>
                    <a asp-action="HealthProgress" asp-route-id="@Model.Id" class="btn btn-outline-danger btn-sm rounded-pill px-3">
                        <i class="fas fa-chart-line me-1"></i> @Localizer["TrackProgress"]
                    </a>
                </div>
            
            @if (Model.HealthRecord != null)
            {
                <div class="row g-4 px-2">
                    <div class="col-md-3 col-6">
                        <div class="text-center p-3 bg-light rounded-4">
                            <i class="fas fa-ruler-vertical text-primary fs-3 mb-2"></i>
                            <div class="small text-secondary text-uppercase fw-bold">@Localizer["Height"]</div>
                            <div class="fs-4 fw-bold">@Model.HealthRecord.Height.ToString("F1")</div>
                            <div class="small text-secondary">@Localizer["CM"]</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="text-center p-3 bg-light rounded-4">
                            <i class="fas fa-weight text-success fs-3 mb-2"></i>
                            <div class="small text-secondary text-uppercase fw-bold">@Localizer["Weight"]</div>
                            <div class="fs-4 fw-bold">@Model.HealthRecord.Weight.ToString("F1")</div>
                            <div class="small text-secondary">@Localizer["KG"]</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="text-center p-3 bg-light rounded-4">
                            <i class="fas fa-tint text-danger fs-3 mb-2"></i>
                            <div class="small text-secondary text-uppercase fw-bold">@Localizer["BloodType"]</div>
                            <div class="fs-4 fw-bold">@(Model.HealthRecord.BloodType ?? "—")</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="text-center p-3 bg-light rounded-4 h-100 d-flex flex-column justify-content-center">
                            <div class="small text-secondary text-uppercase fw-bold mb-1">@Localizer["BMI"]</div>
                            @if (Model.HealthRecord.Height > 0 && Model.HealthRecord.Weight > 0)
                            {
                                var bmi = (double)Model.HealthRecord.Weight / Math.Pow((double)Model.HealthRecord.Height / 100, 2);
                                var bmiClass = bmi < 18.5 ? "text-warning" : bmi < 25 ? "text-success" : bmi < 30 ? "text-warning" : "text-danger";
                                <div class="fs-4 fw-bold @bmiClass">@bmi.ToString("F1")</div>
                            }
                            else
                            {
                                <div class="fs-4 fw-bold">—</div>
                            }
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.HealthRecord.Note))
                    {
                        <div class="col-12 mt-4">
                            <div class="p-4 bg-warning bg-opacity-10 rounded-4 border border-warning border-opacity-10">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-notes-medical text-warning me-3 fs-3"></i>
                                    <div>
                                        <div class="small text-secondary text-uppercase fw-bold mb-1">@Localizer["MedicalNotes"]</div>
                                        <div class="fw-medium">@Model.HealthRecord.Note</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-file-medical text-secondary fs-1 mb-3 opacity-25"></i>
                    <p class="text-secondary mb-0">@Localizer["NoHealthRecord"]</p>
                </div>
            }
        </div>

        <!-- Attendance History -->
        <div class="premium-card p-4 mt-4 shadow-sm border-0">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center">
                    <div class="icon-shape bg-warning bg-opacity-10 text-warning me-3">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <h5 class="fw-bold mb-0">@Localizer["AttendanceHistoryAnalysis"]</h5>
                </div>
            </div>

            <!-- Attendance Chart -->
            <div class="mb-5 p-4 rounded-4 bg-light border border-opacity-10 shadow-inner">
                <canvas id="attendanceChart" height="120"></canvas>
            </div>

            @if (Model.CheckInHistory != null && Model.CheckInHistory.Any())
            {
                <div class="table-responsive rounded-4 overflow-hidden border">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">@Localizer["Date"]</th>
                                <th>@Localizer["Time"]</th>
                                <th>@Localizer["Notes"]</th>
                                <th class="text-end pe-4">@Localizer["Status"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in Model.CheckInHistory.Take(5))
                            {
                                <tr>
                                    <td class="ps-4">@DateTime.Parse(entry.CheckInTime).ToLongDateString()</td>
                                    <td>@DateTime.Parse(entry.CheckInTime).ToShortTimeString()</td>
                                    <td>@(string.IsNullOrEmpty(entry.Notes) ? "—" : entry.Notes)</td>
                                    <td class="text-end pe-4"><span class="badge bg-success rounded-pill px-3">@Localizer["Verified"]</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5 border-2 border-dashed rounded-4 bg-light bg-opacity-50">
                    <i class="fas fa-history text-secondary fs-1 mb-3 opacity-25"></i>
                    <p class="text-secondary mb-0">@Localizer["NoAttendanceRecords"]</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/member.js" asp-append-version="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function() {
            // QR Code
            var qr = new QRious({
                element: document.getElementById('qr-code'),
                size: 100,
                value: '@Model.AccessKey'
            });

            // Attendance Chart
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            // Process data from Model
            const rawData = @Html.Raw(Json.Serialize(Model.CheckInHistory?.Select(h => DateTime.Parse(h.CheckInTime)) ?? new List<DateTime>()));
            
            // Generate last 6 months labels
            const months = [];
            const dataCounts = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthName = date.toLocaleString('default', { month: 'short' });
                months.push(monthName);
                
                // Count visits in this month
                const count = rawData.filter(d => {
                    const checkInDate = new Date(d);
                    return checkInDate.getMonth() === date.getMonth() && 
                           checkInDate.getFullYear() === date.getFullYear();
                }).length;
                dataCounts.push(count);
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(13, 110, 253, 0.5)');
            gradient.addColorStop(1, 'rgba(13, 110, 253, 0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '@Localizer["VisitsPerMonth"]',
                        data: dataCounts,
                        borderColor: '#0d6efd',
                        borderWidth: 3,
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#0d6efd',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        })();
    </script>
}
