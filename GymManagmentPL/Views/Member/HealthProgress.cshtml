@inject IStringLocalizer<SharedResource> Localizer
@model MemberViewModel
@{
    ViewData["Title"] = Localizer["HealthProgression"];
    var progressRecords = ViewBag.Progress as IEnumerable<HealthProgressViewModel> ?? new List<HealthProgressViewModel>();
}

<style>
    /* Force high z-index for modal to overcome sidebar/header stacking issues */
    #addMeasurementModal {
        z-index: 2500 !important;
    }
    .modal-backdrop.show {
        z-index: 2400 !important;
    }
    /* Fix for the backdrop sometimes remaining transparent or misplaced */
    .modal-open .modal-backdrop {
        opacity: 0.6 !important;
    }
</style>

<div class="row mb-4 align-items-center mt-4">
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a asp-action="Index" class="text-decoration-none">@Localizer["Members"]</a></li>
                <li class="breadcrumb-item"><a asp-action="Details" asp-route-id="@Model.Id" class="text-decoration-none">@Model.Name</a></li>
                <li class="breadcrumb-item active">@Localizer["Progression"]</li>
            </ol>
        </nav>
        <h2 class="fw-bold mb-0">
            <i class="fas fa-chart-line text-danger me-2"></i>@Localizer["HealthProgression"]
        </h2>
    </div>
    <div class="col-md-6 text-md-end">
        <button type="button" class="btn btn-danger rounded-pill px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#addMeasurementModal">
            <i class="fas fa-plus me-2"></i>@Localizer["AddMeasurement"]
        </button>
        <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary rounded-pill px-4 ms-2">
            <i class="fas fa-arrow-left me-2"></i>@Localizer["Back"]
        </a>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Weight Trend Chart -->
    <div class="col-lg-8">
        <div class="premium-card p-4 h-100 shadow-sm border-0">
            <h5 class="fw-bold mb-4">@Localizer["WeightTrend"]</h5>
            <div class="chart-container" style="position: relative; height:300px; width:100%">
                <canvas id="weightChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Latest Stats Card -->
    <div class="col-lg-4">
        <div class="premium-card p-4 h-100 shadow-sm border-0 bg-primary text-white">
            <h5 class="fw-bold mb-4">@Localizer["CurrentStatus"]</h5>
            @{
                var latest = progressRecords.FirstOrDefault() ?? new HealthProgressViewModel 
                { 
                    Weight = Model.HealthRecord?.Weight ?? 0,
                    Height = Model.HealthRecord?.Height ?? 0,
                    BMI = Model.HealthRecord?.Height > 0 ? (decimal)((double)Model.HealthRecord.Weight / Math.Pow((double)Model.HealthRecord.Height / 100, 2)) : 0
                };
            }
            <div class="mb-4">
                <div class="small opacity-75 text-uppercase">@Localizer["CurrentWeight"]</div>
                <div class="display-5 fw-bold">@latest.Weight.ToString("F1") <span class="fs-4 fw-normal">@Localizer["KG"]</span></div>
            </div>
            
            <div class="row g-3">
                <div class="col-6">
                    <div class="p-3 bg-white bg-opacity-10 rounded-4">
                        <div class="small opacity-75">@Localizer["BMI"]</div>
                        <div class="h4 fw-bold mb-0">@latest.BMI.ToString("F1")</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 bg-white bg-opacity-10 rounded-4">
                        <div class="small opacity-75">@Localizer["BodyFat"]</div>
                        <div class="h4 fw-bold mb-0">@(latest.BodyFatPercentage?.ToString("F1") ?? "—")%</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-white bg-opacity-10 rounded-4 border border-white border-opacity-10">
                <div class="d-flex justify-content-between align-items-center">
                    <span>@Localizer["LastCheck"]</span>
                    <span class="fw-bold">@(progressRecords.Any() ? progressRecords.First().ProgressDate.ToShortDateString() : Localizer["NA"].Value)</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- BMI Trend Chart -->
    <div class="col-lg-6">
        <div class="premium-card p-4 shadow-sm border-0">
            <h5 class="fw-bold mb-4">@Localizer["BMITrend"]</h5>
            <div class="chart-container" style="position: relative; height:250px; width:100%">
                <canvas id="bmiChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Measurement History Table -->
    <div class="col-lg-6">
        <div class="premium-card p-4 shadow-sm border-0">
            <h5 class="fw-bold mb-4">@Localizer["ProgressHistory"]</h5>
            @if (progressRecords.Any())
            {
                <div class="table-responsive" style="max-height: 250px;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>@Localizer["Date"]</th>
                                <th>@Localizer["Weight"]</th>
                                <th>@Localizer["BMI"]</th>
                                <th>@Localizer["Fat"] %</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in progressRecords)
                            {
                                <tr>
                                    <td class="small">@record.ProgressDate.ToString("MMM dd, yyyy")</td>
                                    <td class="fw-bold">@record.Weight.ToString("F1")</td>
                                    <td>@record.BMI.ToString("F1")</td>
                                    <td>@(record.BodyFatPercentage?.ToString("F1") ?? "—")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-notes-medical fs-1 text-secondary opacity-25 mb-3"></i>
                    <p class="text-muted mb-0">@Localizer["NoProgressRecords"]</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Add Measurement Modal -->
<div class="modal fade" id="addMeasurementModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">@Localizer["AddMeasurement"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="@Url.Action("AddHealthProgress", "Member")" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="MemberId" value="@Model.Id" />
                <input type="hidden" name="Height" value="@(Model.HealthRecord?.Height ?? 0)" />
                
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-uppercase">@Localizer["Weight"] (@Localizer["KG"])</label>
                            <input type="number" step="0.1" name="Weight" class="form-control rounded-3" value="@(Model.HealthRecord?.Weight ?? 0)" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-uppercase">@Localizer["BodyFat"] (%)</label>
                            <input type="number" step="0.1" name="BodyFatPercentage" class="form-control rounded-3" placeholder="e.g. 15.5" />
                            <small class="text-muted" style="font-size: 10px;">@Localizer["FromInBodyDevice"]</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-uppercase">@Localizer["MuscleMass"] (kg)</label>
                            <input type="number" step="0.1" name="MuscleMass" class="form-control rounded-3" placeholder="e.g. 35" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-uppercase">@Localizer["Date"]</label>
                            <input type="date" name="ProgressDate" class="form-control rounded-3" value="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold small text-uppercase">@Localizer["Notes"]</label>
                            <textarea name="Note" class="form-control rounded-3" rows="2" placeholder="e.g. Measured after morning session"></textarea>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3 py-2 small border-0 bg-light">
                        <i class="fas fa-info-circle me-1"></i> @Localizer["BMIUpdateInfo"]
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                    <button type="submit" class="btn btn-danger rounded-pill px-4 shadow-sm">@Localizer["SaveMeasurement"]</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function() {
            const progressData = @Html.Raw(Json.Serialize(progressRecords.OrderBy(r => r.ProgressDate)));
            
            const labels = progressData.map(r => new Date(r.progressDate).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
            const weights = progressData.map(r => r.weight);
            const bmis = progressData.map(r => r.bmi);

            // Weight Chart
            const wCtx = document.getElementById('weightChart').getContext('2d');
            const wGradient = wCtx.createLinearGradient(0, 0, 0, 300);
            wGradient.addColorStop(0, 'rgba(220, 53, 69, 0.2)');
            wGradient.addColorStop(1, 'rgba(220, 53, 69, 0)');

            new Chart(wCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '@Localizer["Weight"] (@Localizer["KG"])',
                        data: weights,
                        borderColor: '#dc3545',
                        backgroundColor: wGradient,
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#dc3545',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // BMI Chart
            const bCtx = document.getElementById('bmiChart').getContext('2d');
            new Chart(bCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'BMI',
                        data: bmis,
                        borderColor: '#0d6efd',
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        })();

        // Robust fix for modal stacking issues
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('addMeasurementModal');
            if (modal) {
                // Move to body BEFORE any bootstrap interaction
                document.body.appendChild(modal);
            }
        });
    </script>
}
