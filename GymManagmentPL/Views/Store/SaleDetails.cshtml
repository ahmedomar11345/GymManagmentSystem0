@model GymManagmentBLL.ViewModels.StoreViewModel.SaleDetailsViewModel
@inject IStringLocalizer<SharedResource> Localizer
@inject GymManagmentBLL.Service.Interfaces.IGymSettingsService GymService
@{
    var settings  = await GymService.GetSettingsAsync();
    var gymName   = settings?.GymName ?? "IronPulse Gym";
    var currency  = settings?.Currency ?? "EGP";
    var logoUrl   = settings?.LogoUrl;
    var isRtl     = System.Globalization.CultureInfo.CurrentUICulture.TextInfo.IsRightToLeft;
    ViewData["Title"] = $"#{Model.Id}";

    var (pmIcon, pmColor, pmLabel) = Model.PaymentMethod switch {
        GymManagmentDAL.Entities.Enums.PaymentMethod.InstaPay     => ("fas fa-mobile-alt",  "primary", Localizer["InstaPay"].Value),
        GymManagmentDAL.Entities.Enums.PaymentMethod.VodafoneCash => ("fas fa-sim-card",    "danger",  Localizer["VodafoneCash"].Value),
        _                                                           => ("fas fa-money-bill-wave", "success", Localizer["Cash"].Value)
    };
}


<style>
/* ═══════════════════════════════════════════════════════
   SCREEN STYLES
   ═══════════════════════════════════════════════════════ */
.receipt-wrap       { max-width: 520px; margin: auto; perspective: 1000px; }
.receipt-card       { border: none; border-radius: 2rem; overflow: hidden;
                      background: var(--card-bg); box-shadow: 0 20px 50px rgba(0,0,0,.15);
                      animation: slideUp .6s cubic-bezier(0.16, 1, 0.3, 1); }
.receipt-head       { background: linear-gradient(145deg, var(--primary-color) 0%, #1a43bf 100%);
                      color: white; padding: 3rem 2rem; text-align: center; position: relative; }
.receipt-logo-wrap  { width: 70px; height: 70px; background: white; border-radius: 50%;
                      padding: 10px; margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center;
                      box-shadow: 0 10px 20px rgba(0,0,0,.1); }
.receipt-body       { padding: 2.5rem; }
.receipt-divider    { border: none; border-top: 2px dashed var(--glass-border); margin: 2rem 0; opacity: 0.6; }
.receipt-total-box  { background: linear-gradient(to right, rgba(59,130,246,.08), rgba(59,130,246,.03));
                      border: 1px solid rgba(59,130,246,.15);
                      border-radius: 1.25rem; padding: 1.5rem; position: relative; overflow: hidden; }
.receipt-total-box::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary-color); }
[data-theme="dark"] .receipt-total-box { background: rgba(59,130,246,.14); }
.receipt-footer     { text-align: center; color: var(--text-main); font-size: .9rem; padding: 2rem; border-top: 1px dashed var(--glass-border); }

/* items table */
.receipt-items th   { font-size: .8rem; text-transform: uppercase; letter-spacing:.08em;
                      color: var(--text-main); font-weight: 800; padding: 1.25rem 0; border: none;
                      border-bottom: 2px solid var(--glass-border); }
.receipt-items td   { padding: 1.5rem 0; border-bottom: 1px solid var(--glass-border); vertical-align: middle; color: var(--text-main); }
.receipt-items tr:last-child td { border: none; }

@@keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ═══════════════════════════════════════════════════════
   PRINT STYLES — 80mm thermal printer
   ═══════════════════════════════════════════════════════ */
@@media print {
    /* 1 — hide everything except the receipt */
    body > * { visibility: hidden !important; }
    .receipt-print-root, .receipt-print-root * { visibility: visible !important; }

    /* 2 — reset page */
    @@page { size: 80mm auto; margin: 0; }

    body {
        margin: 0; padding: 0;
        background: white !important;
        color: black !important;
        font-family: 'Cairo', 'Inter', sans-serif !important;
        font-size: 11pt !important;
        line-height: 1.4 !important;
        width: 80mm !important;
    }

    /* 3 — position the receipt block */
    .receipt-print-root {
        position: absolute !important;
        left: 0 !important; top: 0 !important;
        width: 72mm !important; /* Slightly less than 80mm for margins */
        padding: 5mm !important;
        margin: 0 auto !important;
        background: white !important;
        color: black !important;
    }

    /* 4 — hide UI elements */
    .no-print { display: none !important; }
    .receipt-card { border: none !important; box-shadow: none !important; border-radius: 0 !important; background: white !important; }

    /* 5 — header */
    .receipt-head {
        background: white !important;
        color: black !important;
        padding: 0 0 10px !important;
        border-bottom: 2px dashed black !important;
        margin-bottom: 15px !important;
    }
    .receipt-head h3 { font-size: 16pt !important; font-weight: 800 !important; }

    /* 6 — body */
    .receipt-body { padding: 5px 0 !important; }
    .receipt-divider { border-top: 1px dashed black !important; margin: 8px 0 !important; }
    
    .receipt-total-box {
        background: transparent !important; 
        border: none !important;
        border-top: 2px solid black !important; 
        border-radius: 0 !important;
        padding: 10px 0 !important; 
        margin-top: 10px !important;
    }
    
    .receipt-footer { 
        padding-top: 15px !important; 
        border-top: 1px dashed black !important; 
        font-size: 10pt !important; 
        margin-top: 15px !important;
        text-align: center !important;
    }

    /* 7 — table */
    .receipt-items { width: 100% !important; margin-bottom: 10px !important; border-collapse: collapse !important; }
    .receipt-items th {
        font-size: 10pt !important; 
        padding: 5px 0 !important;
        border-bottom: 1px solid black !important;
        color: black !important;
        font-weight: 900 !important;
    }
    .receipt-items td {
        font-size: 11pt !important; 
        padding: 8px 0 !important;
        border-bottom: none !important;
        color: black !important;
    }
    .receipt-items tbody tr:not(:last-child) td { border-bottom: 1px dashed #ccc !important; }
    .receipt-items .fw-semibold { font-weight: 700 !important; }

    /* 8 — badges & colors */
    .badge { border: 1px solid black !important; background: transparent !important; color: black !important; font-weight: bold !important; }
    [class*="text-"] { color: black !important; }
    .text-secondary, .text-muted { color: #333 !important; } /* Darker text for print */
    
    img { max-height: 50px !important; filter: contrast(150%) grayscale(100%) !important; margin-bottom: 5px !important; }

    /* Labels */
    .small.text-secondary.fw-bold { font-size: 10pt !important; color: black !important; font-weight: 800 !important; }
    .h6 { font-size: 12pt !important; font-weight: 700 !important; }
    
    /* Total Amounts */
    .receipt-total-box .h5 { font-size: 14pt !important; font-weight: 800 !important; }
    .receipt-total-box .fw-black { font-size: 24pt !important; font-weight: 900 !important; }
}
</style>

<!-- Action bar (hidden on print) -->
<div class="no-print animate-fade-in">
    <div class="d-flex align-items-center gap-3 mb-4 flex-wrap">
        <a asp-action="Index" class="btn-back mb-0">
            <i class="fas @(isRtl ? "fa-chevron-right" : "fa-chevron-left")"></i> @Localizer["BackToStore"]
        </a>
        <a asp-action="SalesHistory" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fas fa-history me-1"></i> @Localizer["SalesHistory"]
        </a>
        <div class="ms-auto d-flex gap-2">
            @if (Model.Status != GymManagmentDAL.Entities.Enums.SaleStatus.Voided)
            {
                <form asp-action="VoidSale" method="post" id="voidSaleForm_@Model.Id">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="button" class="btn btn-outline-danger rounded-pill px-4"
                            onclick="confirmSubmit(document.getElementById('voidSaleForm_@Model.Id'), '@Localizer["VoidSale"]', '@Localizer["VoidSaleConfirm"]', 'warning')">
                        <i class="fas fa-ban me-1"></i> @Localizer["VoidSale"]
                    </button>
                </form>
            }
            else
            {
                <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3 d-flex align-items-center">
                    <i class="fas fa-ban me-1"></i> @Localizer["Voided"]
                </span>
            }
            <button onclick="window.print()" class="btn btn-success rounded-pill px-4 shadow-sm">
                <i class="fas fa-print me-1"></i> @Localizer["Print"]
            </button>
        </div>
    </div>
</div>

<!-- ──── PRINTABLE RECEIPT ──── -->
<div class="receipt-print-root receipt-wrap animate-fade-in">
<div class="receipt-card">

    <!-- Header -->
    <div class="receipt-head">
        <div class="receipt-logo-wrap animate-pop">
            @if (!string.IsNullOrEmpty(logoUrl))
            {
                <img src="@logoUrl" alt="@gymName" style="max-height:100%; max-width:100%; object-fit:contain;" />
            }
            else
            {
                <i class="fas fa-dumbbell text-primary fa-2x"></i>
            }
        </div>
        <h3 class="fw-bold mb-1" style="letter-spacing: -0.02em;">@gymName</h3>
        <p class="mb-0" style="font-size:.85rem;opacity:.8;letter-spacing:.1em;text-transform:uppercase;font-weight:600;">
            <i class="fas fa-shopping-cart me-2"></i>@Localizer["StoreSale"]
        </p>
        <div class="mt-4 pt-4 border-top border-white border-opacity-10" style="font-size:.78rem;opacity:.7;">
            <span class="bg-white bg-opacity-10 rounded-pill px-3 py-1">
                @if (!string.IsNullOrEmpty(Model.InvoiceNumber))
                {
                    <i class="fas fa-file-invoice me-1 small"></i>@Model.InvoiceNumber @:&nbsp;&bull;&nbsp;
                }
                else
                {
                    <i class="fas fa-hashtag me-1 small"></i>@Model.Id @:&nbsp;&bull;&nbsp;
                }
                <i class="far fa-calendar-alt me-1 ms-2 small"></i>@Model.SaleDate.ToString("dd MMM yyyy") &nbsp;&bull;&nbsp; <i class="far fa-clock me-1 ms-2 small"></i>@Model.SaleDate.ToString("hh:mm tt")
            </span>
        </div>
    </div>

    <!-- Body -->
    <div class="receipt-body">

        <!-- Customer + Payment -->
        <div class="row g-4 mb-2">
            <div class="col-6 border-end border-light">
                <div class="small text-secondary fw-bold mb-2" style="font-size:.68rem;text-transform:uppercase;letter-spacing:.05em;">@Localizer["Customer"]</div>
                <div class="h6 mb-0">
                    @if (!string.IsNullOrEmpty(Model.MemberName))
                    {
                        <span class="text-primary fw-bold"><i class="fas fa-user-circle me-1"></i>@Model.MemberName</span>
                    }
                    else if (!string.IsNullOrEmpty(Model.CustomerName))
                    {
                        <span class="fw-bold">@Model.CustomerName</span>
                    }
                    else
                    {
                        <span class="text-muted italic">@Localizer["WalkInCustomer"]</span>
                    }
                </div>
            </div>
            <div class="col-6 text-end">
                <div class="small text-secondary fw-bold mb-2" style="font-size:.68rem;text-transform:uppercase;letter-spacing:.05em;">@Localizer["Payment"]</div>
                <div class="d-flex align-items-center justify-content-end gap-2">
                    <i class="@pmIcon text-@pmColor"></i>
                    <span class="fw-bold">@pmLabel</span>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.CashierName))
        {
            <div class="no-print mt-3 p-2 rounded-3 border bg-light text-muted small d-flex align-items-center gap-2">
                <i class="fas fa-user-shield opacity-50"></i>
                <span>@Localizer["Cashier"]: <strong>@Model.CashierName</strong> (@(Model.CashierEmail ?? "N/A"))</span>
            </div>
        }

        <hr class="receipt-divider" />

        <!-- Items -->
        <table class="table receipt-items w-100 mb-0">
            <thead>
                <tr>
                    <th class="text-start">@Localizer["Product"]</th>
                    <th class="text-center" style="width:40px;">@Localizer["Qty"]</th>
                    <th class="text-end" style="width:70px;">@Localizer["UnitPrice"]</th>
                    <th class="text-end" style="width:70px;">@Localizer["Total"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>
                            <div class="fw-semibold" style="font-size:.88rem;">@item.ProductName</div>
                        </td>
                        <td class="text-center fw-bold">@item.Quantity</td>
                        <td class="text-end small text-secondary">@item.UnitPrice.ToString("N2")</td>
                        <td class="text-end fw-bold">@item.TotalPrice.ToString("N2")</td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Total Section -->
        <div class="mt-4 pt-2">
            @if (Model.TotalDiscount > 0)
            {
                <div class="d-flex justify-content-between small text-secondary px-2 mb-2">
                    <span>@Localizer["Subtotal"]</span>
                    <span class="fw-semibold">@Model.TotalBeforeDiscount.ToString("N2")</span>
                </div>
                
                @if (!string.IsNullOrEmpty(Model.CouponCode))
                {
                    <div class="d-flex justify-content-between x-small text-success px-2 mb-1">
                        <span><i class="fas fa-ticket-alt me-1"></i>@Localizer["CouponCode"] (@Model.CouponCode)</span>
                        <span>-@((Model.TotalBeforeDiscount - Model.NetTotal - Model.PointsRedeemedValue).ToString("N2"))</span>
                    </div>
                }

                @if (Model.PointsRedeemedValue > 0)
                {
                    <div class="d-flex justify-content-between x-small text-info px-2 mb-1">
                        <span><i class="fas fa-star me-1"></i>@Localizer["PointsRedeemed"]</span>
                        <span>-@Model.PointsRedeemedValue.ToString("N2")</span>
                    </div>
                }

                <div class="d-flex justify-content-between small text-danger px-2 mb-3">
                    <span class="fw-bold"><i class="fas fa-arrow-down me-1"></i>@Localizer["TotalDiscount"]</span>
                    <span class="fw-bold bg-danger bg-opacity-10 px-2 rounded">-@Model.TotalDiscount.ToString("N2")</span>
                </div>
            }

            <!-- Total -->
            <div class="receipt-total-box">
                <div class="d-flex justify-content-between align-items-center mb-0">
                    <div>
                        <div class="small text-secondary fw-bolder text-uppercase" style="font-size:.7rem;letter-spacing:.1em;margin-bottom:2px;">@Localizer["TotalAmount"]</div>
                        <div class="h4 mb-0 fw-black text-primary">@Localizer["GrandTotal"]</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-black text-primary lh-1" style="font-size:2.5rem;">@Model.NetTotal.ToString("N2")</div>
                        <div class="small fw-bold text-secondary text-uppercase" style="font-size:.8rem; letter-spacing: 1px;">@currency</div>
                    </div>
                </div>
                
                @if (Model.PointsEarned > 0)
                {
                    <div class="border-top border-primary border-opacity-10 pt-2 mt-2 d-flex justify-content-between align-items-center">
                        <span class="x-small fw-bold text-primary"><i class="fas fa-gift me-1"></i>@Localizer["PointsEarned"]</span>
                        <span class="badge bg-primary rounded-pill">+@Model.PointsEarned.ToString("N0") pts</span>
                    </div>
                }
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.Notes))
        {
            <div class="p-3 rounded-3 mt-4 border" style="background:rgba(var(--bs-secondary-rgb),0.07);border-color:var(--glass-border)!important;">
                <div class="small text-secondary fw-bold mb-1 text-uppercase" style="font-size:.6rem;">@Localizer["Notes"]</div>
                <div class="small text-secondary italic">
                    <i class="fas fa-quote-left me-1 small opacity-50"></i>@Model.Notes
                </div>
            </div>
        }
    </div>

    <!-- Footer -->
    <div class="receipt-footer border-top border-light py-4">
        <p class="mb-0 fw-semibold text-secondary">
            ✨ @Localizer["ThankYouForChoosing"] <strong>@gymName</strong> ✨
        </p>
        <div class="mt-2 small opacity-50">@Localizer["HaveANiceDay"]</div>
    </div>

</div>
</div>
@section Scripts {
    <script>
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('print') === 'true') {
                setTimeout(() => {
                    window.print();
                }, 500);
            }
        });
    </script>
}
