@model IEnumerable<GymManagmentBLL.ViewModels.StoreViewModel.StockAdjustmentViewModel>
@inject IStringLocalizer<SharedResource> Localizer
@using GymManagmentDAL.Entities.Enums
@{
    ViewData["Title"] = Localizer["StockAdjustments"];
    var isRtl = System.Globalization.CultureInfo.CurrentUICulture.TextInfo.IsRightToLeft;
}

<div class="animate-fade-in">
    <a asp-action="Index" class="btn-back">
        <i class="fas @(isRtl ? "fa-chevron-right" : "fa-chevron-left")"></i> @Localizer["BackToStore"]
    </a>

    <div class="d-flex align-items-center justify-content-between mb-4">
        <div class="d-flex align-items-center gap-3">
            <div class="icon-shape bg-info bg-opacity-10 text-info">
                <i class="fas fa-boxes-stacked fs-5"></i>
            </div>
            <div>
                <h2 class="fw-bold mb-0">@Localizer["StockAdjustments"]</h2>
                <p class="text-secondary mb-0 small">@Localizer["StockAdjustmentsDesc"]</p>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- ── Add Adjustment Form ── -->
        <div class="col-lg-4">
            <div class="premium-card p-4">
                <h6 class="fw-bold mb-3"><i class="fas fa-plus-circle text-primary me-2"></i>@Localizer["NewAdjustment"]</h6>
                <form asp-action="CreateStockAdjustment" method="post">
                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <label class="form-label small fw-semibold">@Localizer["Product"]</label>
                        <select name="ProductId" class="form-select" required>
                            <option value="">-- @Localizer["SelectProduct"] --</option>
                            @foreach (SelectListItem item in (SelectList)ViewBag.Products)
                            {
                                <option value="@item.Value" selected="@item.Selected">@item.Text</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-semibold">@Localizer["AdjustmentType"]</label>
                        <select name="AdjustmentType" class="form-select" id="adjType" required onchange="updateQtySign()">
                            <option value="0">@Localizer["Addition"]</option>
                            <option value="3">@Localizer["Return"]</option>
                            <option value="4">@Localizer["Correction"]</option>
                            <option value="1">@Localizer["Damage"]</option>
                            <option value="2">@Localizer["Loss"]</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-semibold">@Localizer["Quantity"]</label>
                        <input type="number" name="Quantity" id="adjQty" class="form-control" required min="1" placeholder="0" />
                        <div class="form-text small" id="qtyHint">@Localizer["AdjustmentQtyHint"]</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-semibold">@Localizer["Reason"]</label>
                        <textarea name="Reason" class="form-control" rows="2" maxlength="500" placeholder="@Localizer["Optional"]"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 rounded-pill">
                        <i class="fas fa-save me-1"></i> @Localizer["Save"]
                    </button>
                </form>
            </div>
        </div>

        <!-- ── Adjustment Log ── -->
        <div class="col-lg-8">
            <div class="premium-card">
                <div class="p-3 border-bottom d-flex align-items-center justify-content-between">
                    <h6 class="fw-bold mb-0"><i class="fas fa-history text-secondary me-2"></i>@Localizer["AdjustmentLog"]</h6>
                    @if (ViewBag.SelectedProductId != null)
                    {
                        <a asp-action="StockAdjustments" class="btn btn-sm btn-link text-decoration-none py-0">
                            <i class="fas fa-list me-1"></i> @Localizer["ShowAll"]
                        </a>
                    }
                </div>
                @if (Model.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 small">
                            <thead>
                                <tr>
                                    <th class="px-3 text-secondary fw-normal">@Localizer["Date"]</th>
                                    <th class="text-secondary fw-normal">@Localizer["Product"]</th>
                                    <th class="text-center text-secondary fw-normal">@Localizer["AdjustmentType"]</th>
                                    <th class="text-center text-secondary fw-normal">@Localizer["Quantity"]</th>
                                    <th class="text-secondary fw-normal">@Localizer["Reason"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var a in Model)
                                {
                                    var isPositive = a.Quantity > 0;
                                    var typeLabel = a.AdjustmentType switch
                                    {
                                        StockAdjustmentType.Addition => Localizer["Addition"].Value,
                                        StockAdjustmentType.Damage => Localizer["Damage"].Value,
                                        StockAdjustmentType.Loss => Localizer["Loss"].Value,
                                        StockAdjustmentType.Return => Localizer["Return"].Value,
                                        StockAdjustmentType.Correction => Localizer["Correction"].Value,
                                        _ => "?"
                                    };
                                    var badgeColor = a.AdjustmentType switch
                                    {
                                        StockAdjustmentType.Addition => "success",
                                        StockAdjustmentType.Return => "info",
                                        StockAdjustmentType.Correction => "warning",
                                        _ => "danger"
                                    };
                                    <tr>
                                        <td class="px-3">@a.AdjustmentDate.ToString("dd MMM yyyy hh:mm tt")</td>
                                        <td class="fw-semibold">@a.ProductName</td>
                                        <td class="text-center">
                                            <span class="badge bg-@badgeColor bg-opacity-10 text-@badgeColor rounded-pill px-3">@typeLabel</span>
                                        </td>
                                        <td class="text-center fw-bold @(isPositive ? "text-success" : "text-danger")">
                                            @(isPositive ? "+" : "")@a.Quantity
                                        </td>
                                        <td class="text-secondary">@(a.Reason ?? "—")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="p-4 text-center text-secondary">
                        <i class="fas fa-inbox me-1"></i> @Localizer["NoDataAvailable"]
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script>
    var _qtyDeducted = '@Html.Raw(Localizer["QtyWillBeDeducted"].Value)';
    var _qtyAdded = '@Html.Raw(Localizer["QtyWillBeAdded"].Value)';
    function updateQtySign() {
        const type = parseInt(document.getElementById('adjType').value);
        const qtyInput = document.getElementById('adjQty');
        const hint = document.getElementById('qtyHint');
        
        // Always allow positive input, service handles the sign
        qtyInput.min = "1";
        
        if (type === 1 || type === 2) { // Damage or Loss
            hint.textContent = _qtyDeducted;
            hint.classList.add('text-danger');
            hint.classList.remove('text-success');
        } else if (type === 0 || type === 3) { // Addition or Return
            hint.textContent = _qtyAdded;
            hint.classList.add('text-success');
            hint.classList.remove('text-danger');
        } else { // Correction
            qtyInput.min = ""; // Allow both for correction
            hint.textContent = "@Localizer["AdjustmentQtyHint"]";
            hint.classList.remove('text-success', 'text-danger');
        }
    }
    updateQtySign();
</script>
